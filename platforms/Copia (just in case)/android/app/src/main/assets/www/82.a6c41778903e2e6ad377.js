(window.webpackJsonp=window.webpackJsonp||[]).push([[82],{Iaui:function(e,s,t){"use strict";t.r(s),t.d(s,"AddonModWorkshopLazyModule",(function(){return ms}));var o=t("tyNb"),a=t("MLi9"),i=t("L3Fv"),n=t("ghUQ"),r=t("pHTc"),d=t("20uA"),c=t("fXoL"),l=t("TEn/"),h=t("4JiN"),m=t("hMzs"),u=t("nt/U"),p=t("sYmb");let g=(()=>{class AddonModWorkshopIndexPage extends n.a{constructor(){super(...arguments),this.selectedGroup=0}ngOnInit(){super.ngOnInit(),this.selectedGroup=r.a.getRouteNumberParam("group")||0}}return AddonModWorkshopIndexPage.ɵfac=function AddonModWorkshopIndexPage_Factory(e){return f(e||AddonModWorkshopIndexPage)},AddonModWorkshopIndexPage.ɵcmp=c.sc({type:AddonModWorkshopIndexPage,selectors:[["page-addon-mod-workshop-index"]],viewQuery:function AddonModWorkshopIndexPage_Query(e,s){var t;(1&e&&c.ud(d.a,!0),2&e)&&(c.dd(t=c.Nc())&&(s.activityComponent=t.first))},features:[c.ic],decls:14,vars:13,consts:[["collapsible",""],["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],[1,"limited-width"],["slot","fixed",3,"disabled","ionRefresh"],[3,"pullingText"],[3,"module","courseId","group","dataRetrieved"]],template:function AddonModWorkshopIndexPage_Template(e,s){1&e&&(c.Ec(0,"ion-header",0),c.Ec(1,"ion-toolbar"),c.Ec(2,"ion-buttons",1),c.zc(3,"ion-back-button",2),c.Pc(4,"translate"),c.Dc(),c.Ec(5,"ion-title"),c.Ec(6,"h1"),c.zc(7,"core-format-text",3),c.Dc(),c.Dc(),c.zc(8,"ion-buttons",4),c.Dc(),c.Dc(),c.Ec(9,"ion-content",5),c.Ec(10,"ion-refresher",6),c.Mc("ionRefresh",(function AddonModWorkshopIndexPage_Template_ion_refresher_ionRefresh_10_listener(e){return null==s.activityComponent?null:s.activityComponent.doRefresh(e.target)})),c.zc(11,"ion-refresher-content",7),c.Pc(12,"translate"),c.Dc(),c.Ec(13,"addon-mod-workshop-index",8),c.Mc("dataRetrieved",(function AddonModWorkshopIndexPage_Template_addon_mod_workshop_index_dataRetrieved_13_listener(e){return s.updateData(e)})),c.Dc(),c.Dc()),2&e&&(c.lc(3),c.Vc("text",c.Qc(4,9,"core.back")),c.lc(4),c.Vc("text",s.title)("contextInstanceId",s.module.id)("courseId",s.courseId),c.lc(3),c.Vc("disabled",null==s.activityComponent?null:s.activityComponent.showLoading),c.lc(1),c.Wc("pullingText",c.Qc(12,11,"core.pulltorefresh")),c.lc(2),c.Vc("module",s.module)("courseId",s.courseId)("group",s.selectedGroup))},directives:[l.C,h.b,l.Ab,l.m,l.h,l.i,l.yb,m.a,u.a,l.v,l.bb,l.cb,d.a],pipes:[p.d],encapsulation:2}),AddonModWorkshopIndexPage})();const f=c.Gc(g);var _=t("Ie1r"),b=t("WoAp"),v=t("ekpb"),I=t("mrSG"),k=t("3Pt+"),w=t("ULAo"),A=t("FvYb"),E=t("4pns"),P=t("9+EE"),D=t("uT8i"),y=t("3LXp"),M=t("vuGA"),x=t("j3ag"),W=t("fjkH"),S=t("4reR"),T=t("i1f9"),O=t("8/zp"),F=t("EyWp"),V=t("GuJL"),L=t("ACYt"),C=t("ofXK"),R=t("PgjG"),q=t("FeAf"),G=t("Lkkz"),N=t("FasJ"),z=t("N5Lt");const Q=["evaluateFormEl"];function AddonModWorkshopAssessmentPage_ion_refresher_13_Template(e,s){if(1&e){const e=c.Fc();c.Ec(0,"ion-refresher",15),c.Mc("ionRefresh",(function AddonModWorkshopAssessmentPage_ion_refresher_13_Template_ion_refresher_ionRefresh_0_listener(s){c.fd(e);return c.Oc().refreshAssessment(s.target)})),c.zc(1,"ion-refresher-content",16),c.Pc(2,"translate"),c.Dc()}if(2&e){const e=c.Oc();c.Vc("disabled",!e.loaded),c.lc(1),c.Wc("pullingText",c.Qc(2,2,"core.pulltorefresh"))}}function AddonModWorkshopAssessmentPage_core_user_avatar_16_Template(e,s){if(1&e&&c.zc(0,"core-user-avatar",17),2&e){const e=c.Oc();c.Vc("user",e.profile)("courseId",e.courseId)("userId",e.profile.id)}}function AddonModWorkshopAssessmentPage_h2_18_Template(e,s){if(1&e&&(c.Ec(0,"h2"),c.pd(1),c.Dc()),2&e){const e=c.Oc();c.lc(1),c.qd(e.profile.fullname)}}const _c1=function(e){return{$a:e}};function AddonModWorkshopAssessmentPage_p_19_Template(e,s){if(1&e&&(c.Ec(0,"p"),c.pd(1),c.Pc(2,"translate"),c.Dc()),2&e){const e=c.Oc();c.lc(1),c.sd(" ",c.Rc(2,2,"addon.mod_workshop.submissiongradeof",c.ad(5,_c1,e.workshop.grade)),": ",e.assessment.grade," ")}}function AddonModWorkshopAssessmentPage_p_20_Template(e,s){if(1&e&&(c.Ec(0,"p"),c.pd(1),c.Pc(2,"translate"),c.Dc()),2&e){const e=c.Oc();c.qc("core-has-overriden-grade",e.showGrade(e.assessment.gradinggrade)),c.lc(1),c.sd(" ",c.Rc(2,4,"addon.mod_workshop.gradinggradeof",c.ad(7,_c1,e.workshop.gradinggrade)),": ",e.assessment.gradinggrade," ")}}function AddonModWorkshopAssessmentPage_p_21_Template(e,s){if(1&e&&(c.Ec(0,"p",18),c.pd(1),c.Pc(2,"translate"),c.Dc()),2&e){const e=c.Oc();c.lc(1),c.sd(" ",c.Qc(2,2,"addon.mod_workshop.gradinggradeover"),": ",e.assessment.gradinggradeover," ")}}function AddonModWorkshopAssessmentPage_p_22_Template(e,s){if(1&e&&(c.Ec(0,"p"),c.pd(1),c.Pc(2,"translate"),c.Dc()),2&e){const e=c.Oc();c.lc(1),c.rd(" ",c.Rc(2,1,"addon.mod_workshop.weightinfo",c.ad(4,_c1,e.assessment.weight))," ")}}function AddonModWorkshopAssessmentPage_ion_badge_23_Template(e,s){1&e&&(c.Ec(0,"ion-badge",19),c.pd(1),c.Pc(2,"translate"),c.Dc()),2&e&&(c.lc(1),c.rd(" ",c.Qc(2,1,"addon.mod_workshop.notassessed")," "))}function AddonModWorkshopAssessmentPage_addon_mod_workshop_assessment_strategy_24_Template(e,s){if(1&e&&c.zc(0,"addon-mod-workshop-assessment-strategy",20),2&e){const e=c.Oc();c.Vc("workshop",e.workshop)("access",e.access)("assessmentId",e.assessmentId)("userId",e.profile&&e.profile.id)("strategy",e.strategy)}}function AddonModWorkshopAssessmentPage_form_25_ion_item_7_ion_select_option_7_Template(e,s){if(1&e&&(c.Ec(0,"ion-select-option",28),c.pd(1),c.Dc()),2&e){const e=s.$implicit;c.Vc("value",e),c.lc(1),c.qd(e)}}const _c2=function(e){return{header:e}};function AddonModWorkshopAssessmentPage_form_25_ion_item_7_Template(e,s){if(1&e&&(c.Ec(0,"ion-item",7),c.Ec(1,"ion-label",24),c.Ec(2,"span",25),c.pd(3),c.Pc(4,"translate"),c.Dc(),c.Dc(),c.Ec(5,"ion-select",26),c.Pc(6,"translate"),c.nd(7,AddonModWorkshopAssessmentPage_form_25_ion_item_7_ion_select_option_7_Template,2,2,"ion-select-option",27),c.Dc(),c.Dc()),2&e){const e=c.Oc(2);c.lc(3),c.rd(" ",c.Qc(4,3,"addon.mod_workshop.assessmentweight")," "),c.lc(2),c.Vc("interfaceOptions",c.ad(7,_c2,c.Qc(6,5,"addon.mod_workshop.assessmentweight"))),c.lc(2),c.Vc("ngForOf",e.weights)}}function AddonModWorkshopAssessmentPage_form_25_ion_item_15_ion_select_option_6_Template(e,s){if(1&e&&(c.Ec(0,"ion-select-option",28),c.pd(1),c.Dc()),2&e){const e=s.$implicit;c.Vc("value",e.value),c.lc(1),c.rd(" ",e.label," ")}}function AddonModWorkshopAssessmentPage_form_25_ion_item_15_Template(e,s){if(1&e&&(c.Ec(0,"ion-item",7),c.Ec(1,"ion-label",24),c.pd(2),c.Pc(3,"translate"),c.Dc(),c.Ec(4,"ion-select",29),c.Pc(5,"translate"),c.nd(6,AddonModWorkshopAssessmentPage_form_25_ion_item_15_ion_select_option_6_Template,2,2,"ion-select-option",27),c.Dc(),c.Dc()),2&e){const e=c.Oc(2);c.lc(2),c.qd(c.Qc(3,3,"addon.mod_workshop.gradinggradeover")),c.lc(2),c.Vc("interfaceOptions",c.ad(7,_c2,c.Qc(5,5,"addon.mod_workshop.gradinggradeover"))),c.lc(2),c.Vc("ngForOf",e.evaluationGrades)}}const _c3=function(e){return{asid:e}};function AddonModWorkshopAssessmentPage_form_25_ion_item_16_Template(e,s){if(1&e&&(c.Ec(0,"ion-item"),c.Ec(1,"ion-label",24),c.pd(2),c.Pc(3,"translate"),c.Dc(),c.zc(4,"core-rich-text-editor",30),c.Dc()),2&e){const e=c.Oc(2);c.lc(2),c.qd(c.Qc(3,5,"addon.mod_workshop.feedbackreviewer")),c.lc(2),c.Vc("control",e.evaluateForm.controls.text)("autoSave",!0)("contextInstanceId",null==e.workshop?null:e.workshop.coursemodule)("draftExtraParams",c.ad(7,_c3,e.assessmentId))}}function AddonModWorkshopAssessmentPage_form_25_Template(e,s){if(1&e&&(c.Ec(0,"form",21,22),c.Ec(2,"ion-item",7),c.Ec(3,"ion-label"),c.Ec(4,"h2"),c.pd(5),c.Pc(6,"translate"),c.Dc(),c.Dc(),c.Dc(),c.nd(7,AddonModWorkshopAssessmentPage_form_25_ion_item_7_Template,8,9,"ion-item",23),c.Ec(8,"ion-item",7),c.Ec(9,"ion-label"),c.Ec(10,"h2"),c.pd(11),c.Pc(12,"translate"),c.Dc(),c.Ec(13,"p"),c.pd(14),c.Dc(),c.Dc(),c.Dc(),c.nd(15,AddonModWorkshopAssessmentPage_form_25_ion_item_15_Template,7,9,"ion-item",23),c.nd(16,AddonModWorkshopAssessmentPage_form_25_ion_item_16_Template,5,9,"ion-item",9),c.Dc()),2&e){const e=c.Oc();c.Vc("formGroup",e.evaluateForm),c.lc(5),c.qd(c.Qc(6,7,"addon.mod_workshop.assessmentsettings")),c.lc(2),c.Vc("ngIf",null==e.access?null:e.access.canallocate),c.lc(4),c.qd(c.Qc(12,9,"addon.mod_workshop.gradinggradecalculated")),c.lc(3),c.qd(e.gradingGrade),c.lc(1),c.Vc("ngIf",null==e.access?null:e.access.canoverridegrades),c.lc(1),c.Vc("ngIf",null==e.access?null:e.access.canoverridegrades)}}function AddonModWorkshopAssessmentPage_ion_list_26_core_user_avatar_2_Template(e,s){if(1&e&&c.zc(0,"core-user-avatar",17),2&e){const e=c.Oc(2);c.Vc("user",e.evaluateByProfile)("courseId",e.courseId)("userId",e.evaluateByProfile.id)}}function AddonModWorkshopAssessmentPage_ion_list_26_h2_4_Template(e,s){if(1&e&&(c.Ec(0,"h2"),c.pd(1),c.Pc(2,"translate"),c.Dc()),2&e){const e=c.Oc(2);c.lc(1),c.rd(" ",c.Rc(2,1,"addon.mod_workshop.feedbackby",c.ad(4,_c1,e.evaluateByProfile.fullname))," ")}}function AddonModWorkshopAssessmentPage_ion_list_26_Template(e,s){if(1&e&&(c.Ec(0,"ion-list"),c.Ec(1,"ion-item",7),c.nd(2,AddonModWorkshopAssessmentPage_ion_list_26_core_user_avatar_2_Template,1,3,"core-user-avatar",8),c.Ec(3,"ion-label"),c.nd(4,AddonModWorkshopAssessmentPage_ion_list_26_h2_4_Template,3,6,"h2",9),c.zc(5,"core-format-text",2),c.Dc(),c.Dc(),c.Dc()),2&e){const e=c.Oc();c.lc(2),c.Vc("ngIf",e.evaluateByProfile),c.lc(2),c.Vc("ngIf",e.evaluateByProfile&&e.evaluateByProfile.fullname),c.lc(1),c.Vc("text",e.evaluate.text)("contextInstanceId",null==e.workshop?null:e.workshop.coursemodule)("courseId",e.courseId)}}let U=(()=>{class AddonModWorkshopAssessmentPage{constructor(e){this.fb=e,this.evaluating=!1,this.loaded=!1,this.title="",this.evaluate={text:"",grade:-1,weight:1},this.weights=[],this.evaluationGrades=[],this.originalEvaluation={text:"",grade:-1,weight:1},this.hasOffline=!1,this.isDestroyed=!1,this.forceLeave=!1,this.siteId=P.b.getCurrentSiteId(),this.currentUserId=P.b.getCurrentSiteUserId(),this.showGrade=O.a.showGrade,this.evaluateForm=new k.j({}),this.evaluateForm.addControl("weight",this.fb.control("",k.F.required)),this.evaluateForm.addControl("grade",this.fb.control("")),this.evaluateForm.addControl("text",this.fb.control("")),this.syncObserver=W.b.on(V.b.AUTO_SYNCED,(e=>{this.workshopId===e.workshopId&&(this.loaded=!1,this.refreshAllData())}),this.siteId)}ngOnInit(){try{this.assessment=r.a.getRequiredRouteParam("assessment"),this.submission=r.a.getRequiredRouteParam("submission"),this.profile=r.a.getRouteParam("profile"),this.courseId=r.a.getRequiredRouteNumberParam("courseId")}catch(e){return y.a.showErrorModal(e),r.a.back(),void 0}this.assessmentId=this.assessment.id,this.workshopId=this.submission.workshopid,this.fetchAssessmentData()}canLeave(){return Object(I.a)(this,void 0,void 0,(function*(){return!(!this.forceLeave&&this.evaluating)||(!this.hasEvaluationChanged()||(yield y.a.showConfirm(x.J.instant("core.confirmcanceledit")),S.a.triggerFormCancelledEvent(this.formElement,this.siteId),!0))}))}fetchAssessmentData(){var e,s;return Object(I.a)(this,void 0,void 0,(function*(){try{this.workshop=yield T.a.getWorkshopById(this.courseId,this.workshopId),this.title=this.workshop.name,this.strategy=this.workshop.strategy;const t=yield w.a.getModuleBasicGradeInfo(this.workshop.coursemodule);if(this.maxGrade=null==t?void 0:t.grade,this.access=yield T.a.getWorkshopAccessInformation(this.workshopId,{cmId:this.workshop.coursemodule}),this.assessmentId&&(this.access.canallocate||this.access.canoverridegrades)?(this.isDestroyed||D.a.blockOperation(T.f.COMPONENT,this.workshopId),this.evaluating=!0):this.evaluating=!1,!this.evaluating&&this.workshop.phase!=T.e.PHASE_CLOSED)return;const o=yield O.a.getReviewerAssessmentById(this.workshopId,this.assessmentId,{userId:null===(e=this.profile)||void 0===e?void 0:e.id,cmId:this.workshop.coursemodule});if(this.assessment=O.a.realGradeValue(this.workshop,o),this.evaluate.text=this.assessment.feedbackreviewer||"",this.evaluate.weight=this.assessment.weight,this.gradingGrade=null!==(s=this.assessment.gradinggrade)&&void 0!==s?s:"-",this.evaluating){if(this.access.canallocate){this.weights=[];for(let e=16;e>=0;e--)this.weights[e]=e}if(this.access.canoverridegrades){const e=x.J.instant("addon.mod_workshop.notoverridden");this.evaluationGrades=yield A.a.makeGradesMenu(this.workshop.gradinggrade,void 0,e,-1)}try{const e=yield F.a.getEvaluateAssessment(this.workshopId,this.assessmentId);this.hasOffline=!0,this.evaluate.weight=e.weight,this.access.canoverridegrades&&(this.evaluate.text=e.feedbacktext||"",this.evaluate.grade=parseInt(e.gradinggradeover,10)||-1)}catch(e){this.hasOffline=!1,this.access.canoverridegrades&&(this.evaluate.text=this.assessment.feedbackreviewer||"",this.evaluate.grade=parseInt(String(this.assessment.gradinggradeover),10)||-1)}finally{this.originalEvaluation.weight=this.evaluate.weight,this.access.canoverridegrades&&(this.originalEvaluation.text=this.evaluate.text,this.originalEvaluation.grade=this.evaluate.grade),this.evaluateForm.controls.weight.setValue(this.evaluate.weight),this.access.canoverridegrades&&(this.evaluateForm.controls.grade.setValue(this.evaluate.grade),this.evaluateForm.controls.text.setValue(this.evaluate.text))}}else this.workshop.phase==T.e.PHASE_CLOSED&&this.assessment.gradinggradeoverby&&(this.evaluateByProfile=yield E.a.getProfile(this.assessment.gradinggradeoverby,this.courseId,!0))}catch(e){y.a.showErrorModalDefault(e,"mm.course.errorgetmodule",!0)}finally{this.loaded=!0}}))}forceLeavePage(){this.forceLeave=!0,r.a.back()}hasEvaluationChanged(){if(!this.loaded||!this.evaluating)return!1;const e=this.evaluateForm.value;if(this.originalEvaluation.weight!=e.weight)return!0;if(this.access&&this.access.canoverridegrades){if(this.originalEvaluation.text!=e.text)return!0;if(this.originalEvaluation.grade!=e.grade)return!0}return!1}refreshAllData(){return Object(I.a)(this,void 0,void 0,(function*(){const e=[];e.push(T.a.invalidateWorkshopData(this.courseId)),e.push(T.a.invalidateWorkshopAccessInformationData(this.workshopId)),e.push(T.a.invalidateReviewerAssesmentsData(this.workshopId)),this.assessmentId&&(e.push(T.a.invalidateAssessmentFormData(this.workshopId,this.assessmentId)),e.push(T.a.invalidateAssessmentData(this.workshopId,this.assessmentId)));try{yield Promise.all(e)}finally{W.b.trigger(T.f.ASSESSMENT_INVALIDATED,null,this.siteId),yield this.fetchAssessmentData()}}))}refreshAssessment(e){this.loaded&&this.refreshAllData().finally((()=>{null==e?void 0:e.complete()}))}saveEvaluation(){return Object(I.a)(this,void 0,void 0,(function*(){this.hasEvaluationChanged()&&(yield this.sendEvaluation()),this.forceLeavePage()}))}sendEvaluation(){return Object(I.a)(this,void 0,void 0,(function*(){const e=yield y.a.showModalLoading("core.sending",!0),s=this.evaluateForm.value,t=s.grade>=0?String(s.grade):"",o=M.a.formatHtmlLines(s.text);try{const a=yield T.a.evaluateAssessment(this.workshopId,this.assessmentId,this.courseId,o,s.weight,t);S.a.triggerFormSubmittedEvent(this.formElement,!!a,this.siteId);const i={workshopId:this.workshopId,assessmentId:this.assessmentId,userId:this.currentUserId};return T.a.invalidateAssessmentData(this.workshopId,this.assessmentId).finally((()=>{W.b.trigger(T.f.ASSESSMENT_SAVED,i,this.siteId)}))}catch(e){y.a.showErrorModalDefault(e,"Cannot save assessment evaluation")}finally{e.dismiss()}}))}ngOnDestroy(){var e;this.isDestroyed=!0,null===(e=this.syncObserver)||void 0===e||e.off(),D.a.unblockOperation(T.f.COMPONENT,this.workshopId)}}return AddonModWorkshopAssessmentPage.ɵfac=function AddonModWorkshopAssessmentPage_Factory(e){return new(e||AddonModWorkshopAssessmentPage)(c.yc(k.f))},AddonModWorkshopAssessmentPage.ɵcmp=c.sc({type:AddonModWorkshopAssessmentPage,selectors:[["page-addon-mod-workshop-assessment-page"]],viewQuery:function AddonModWorkshopAssessmentPage_Query(e,s){var t;(1&e&&c.ud(Q,!0),2&e)&&(c.dd(t=c.Nc())&&(s.formElement=t.first))},decls:27,vars:22,consts:[["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end",3,"hidden"],["fill","clear",3,"click"],["slot","fixed",3,"disabled","ionRefresh",4,"ngIf"],[3,"hideUntil"],[1,"ion-text-wrap"],["slot","start",3,"user","courseId","userId",4,"ngIf"],[4,"ngIf"],[3,"core-has-overriden-grade",4,"ngIf"],["class","core-overriden-grade",4,"ngIf"],["color","danger",4,"ngIf"],[3,"workshop","access","assessmentId","userId","strategy",4,"ngIf"],[3,"formGroup",4,"ngIf"],["slot","fixed",3,"disabled","ionRefresh"],[3,"pullingText"],["slot","start",3,"user","courseId","userId"],[1,"core-overriden-grade"],["color","danger"],[3,"workshop","access","assessmentId","userId","strategy"],[3,"formGroup"],["evaluateFormEl",""],["class","ion-text-wrap",4,"ngIf"],["position","stacked"],["core-mark-required","true"],["formControlName","weight","required","true","interface","action-sheet",3,"interfaceOptions"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["formControlName","grade","interface","action-sheet",3,"interfaceOptions"],["name","text","contextLevel","module","elementId","feedbackreviewer_editor",3,"control","autoSave","contextInstanceId","draftExtraParams"]],template:function AddonModWorkshopAssessmentPage_Template(e,s){1&e&&(c.Ec(0,"ion-header"),c.Ec(1,"ion-toolbar"),c.Ec(2,"ion-buttons",0),c.zc(3,"ion-back-button",1),c.Pc(4,"translate"),c.Dc(),c.Ec(5,"ion-title"),c.Ec(6,"h1"),c.zc(7,"core-format-text",2),c.Dc(),c.Dc(),c.Ec(8,"ion-buttons",3),c.Ec(9,"ion-button",4),c.Mc("click",(function AddonModWorkshopAssessmentPage_Template_ion_button_click_9_listener(){return s.saveEvaluation()})),c.pd(10),c.Pc(11,"translate"),c.Dc(),c.Dc(),c.Dc(),c.Dc(),c.Ec(12,"ion-content"),c.nd(13,AddonModWorkshopAssessmentPage_ion_refresher_13_Template,3,4,"ion-refresher",5),c.Ec(14,"core-loading",6),c.Ec(15,"ion-item",7),c.nd(16,AddonModWorkshopAssessmentPage_core_user_avatar_16_Template,1,3,"core-user-avatar",8),c.Ec(17,"ion-label"),c.nd(18,AddonModWorkshopAssessmentPage_h2_18_Template,2,1,"h2",9),c.nd(19,AddonModWorkshopAssessmentPage_p_19_Template,3,7,"p",9),c.nd(20,AddonModWorkshopAssessmentPage_p_20_Template,3,9,"p",10),c.nd(21,AddonModWorkshopAssessmentPage_p_21_Template,3,4,"p",11),c.nd(22,AddonModWorkshopAssessmentPage_p_22_Template,3,6,"p",9),c.nd(23,AddonModWorkshopAssessmentPage_ion_badge_23_Template,3,3,"ion-badge",12),c.Dc(),c.Dc(),c.nd(24,AddonModWorkshopAssessmentPage_addon_mod_workshop_assessment_strategy_24_Template,1,5,"addon-mod-workshop-assessment-strategy",13),c.nd(25,AddonModWorkshopAssessmentPage_form_25_Template,17,11,"form",14),c.nd(26,AddonModWorkshopAssessmentPage_ion_list_26_Template,6,5,"ion-list",9),c.Dc(),c.Dc()),2&e&&(c.lc(3),c.Vc("text",c.Qc(4,18,"core.back")),c.lc(4),c.Vc("text",s.title)("contextInstanceId",s.workshop&&s.workshop.coursemodule)("courseId",s.courseId),c.lc(1),c.Vc("hidden",!s.evaluating),c.lc(2),c.rd(" ",c.Qc(11,20,"core.save")," "),c.lc(3),c.Vc("ngIf",!s.evaluating),c.lc(1),c.Vc("hideUntil",s.loaded),c.lc(2),c.Vc("ngIf",s.profile),c.lc(2),c.Vc("ngIf",s.profile&&s.profile.fullname),c.lc(1),c.Vc("ngIf",s.workshop&&s.assessment&&s.showGrade(s.assessment.grade)),c.lc(1),c.Vc("ngIf",s.workshop&&s.access&&s.access.canviewallsubmissions&&s.assessment&&s.showGrade(s.assessment.gradinggrade)),c.lc(1),c.Vc("ngIf",s.access&&s.access.canviewallsubmissions&&s.assessment&&s.showGrade(s.assessment.gradinggradeover)),c.lc(1),c.Vc("ngIf",s.assessment&&s.assessment.weight&&1!=s.assessment.weight),c.lc(1),c.Vc("ngIf",!s.assessment||!s.showGrade(s.assessment.grade)),c.lc(1),c.Vc("ngIf",s.assessment&&s.assessmentId&&s.showGrade(s.assessment.grade)&&s.workshop&&s.access),c.lc(1),c.Vc("ngIf",s.evaluating),c.lc(1),c.Vc("ngIf",!s.evaluating&&s.evaluate&&s.evaluate.text))},directives:[l.C,l.Ab,l.m,l.h,l.i,l.yb,m.a,L.a,l.l,u.a,l.v,C.t,R.a,l.I,l.O,l.bb,l.cb,q.a,l.k,G.a,k.H,k.s,k.k,N.a,l.lb,l.Ob,k.r,k.i,k.C,C.s,l.mb,z.a,l.P],pipes:[p.d],encapsulation:2}),AddonModWorkshopAssessmentPage})();var j=t("93ts"),B=t("hSQQ"),J=t("EmGO"),H=t("L2dF"),Y=t("bFG1"),K=t("M9y5");const X=["editFormEl"];function AddonModWorkshopEditSubmissionPage_form_16_ion_item_9_Template(e,s){if(1&e&&(c.Ec(0,"ion-item"),c.Ec(1,"ion-label",9),c.Ec(2,"span",14),c.pd(3),c.Pc(4,"translate"),c.Dc(),c.Dc(),c.zc(5,"core-rich-text-editor",15),c.Pc(6,"translate"),c.Dc()),2&e){const e=c.Oc(2);c.lc(2),c.Vc("core-mark-required",e.textRequired),c.lc(1),c.rd(" ",c.Qc(4,9,"addon.mod_workshop.submissioncontent")," "),c.lc(2),c.Vc("control",e.editForm.controls.content)("placeholder",c.Qc(6,11,"addon.mod_workshop.submissioncontent"))("component",e.component)("componentId",e.componentId)("autoSave",!0)("contextInstanceId",e.module.id)("draftExtraParams",e.editorExtraParams)}}function AddonModWorkshopEditSubmissionPage_form_16_core_attachments_10_Template(e,s){if(1&e&&c.zc(0,"core-attachments",16),2&e){const e=c.Oc(2);c.Vc("files",e.attachments)("maxSize",e.workshop.maxbytes)("maxSubmissions",e.workshop.nattachments)("component",e.component)("componentId",e.workshop.coursemodule)("acceptedTypes",e.workshop.submissionfiletypes)("required",e.fileRequired)("courseId",e.workshop.course)}}function AddonModWorkshopEditSubmissionPage_form_16_Template(e,s){if(1&e&&(c.Ec(0,"form",6,7),c.Ec(2,"ion-item",8),c.Ec(3,"ion-label",9),c.Ec(4,"span",10),c.pd(5),c.Pc(6,"translate"),c.Dc(),c.Dc(),c.zc(7,"ion-input",11),c.Pc(8,"translate"),c.Dc(),c.nd(9,AddonModWorkshopEditSubmissionPage_form_16_ion_item_9_Template,7,13,"ion-item",12),c.nd(10,AddonModWorkshopEditSubmissionPage_form_16_core_attachments_10_Template,1,8,"core-attachments",13),c.Dc()),2&e){const e=c.Oc();c.Vc("formGroup",e.editForm),c.lc(5),c.rd(" ",c.Qc(6,5,"addon.mod_workshop.submissiontitle")," "),c.lc(2),c.Vc("placeholder",c.Qc(8,7,"addon.mod_workshop.submissiontitle")),c.lc(2),c.Vc("ngIf",e.textAvailable),c.lc(1),c.Vc("ngIf",e.fileAvailable)}}let Z=(()=>{class AddonModWorkshopEditSubmissionPage{constructor(e){this.fb=e,this.loaded=!1,this.component=T.f.COMPONENT,this.editorExtraParams={},this.textAvailable=!1,this.textRequired=!1,this.fileAvailable=!1,this.fileRequired=!1,this.attachments=[],this.submissionId=0,this.originalData={title:"",content:"",attachmentfiles:[]},this.hasOffline=!1,this.editing=!1,this.forceLeave=!1,this.isDestroyed=!1,this.userId=P.b.getCurrentSiteUserId(),this.siteId=P.b.getCurrentSiteId(),this.editForm=new k.j({}),this.editForm.addControl("title",this.fb.control("",k.F.required)),this.editForm.addControl("content",this.fb.control(""))}ngOnInit(){try{this.module=r.a.getRequiredRouteParam("module"),this.courseId=r.a.getRequiredRouteNumberParam("courseId"),this.access=r.a.getRequiredRouteParam("access"),this.submissionId=r.a.getRouteNumberParam("submissionId")||0}catch(e){return y.a.showErrorModal(e),r.a.back(),void 0}this.submissionId>0&&(this.editorExtraParams.id=this.submissionId),this.workshopId=this.module.instance,this.componentId=this.module.id,this.isDestroyed||D.a.blockOperation(this.component,this.workshopId),this.fetchSubmissionData()}canLeave(){var e;return Object(I.a)(this,void 0,void 0,(function*(){return this.forceLeave||(this.hasDataChanged()&&(yield y.a.showConfirm(x.J.instant("core.confirmcanceledit"))),(null===(e=this.submission)||void 0===e?void 0:e.attachmentfiles)&&B.a.clearTmpFiles(this.submission.attachmentfiles),S.a.triggerFormCancelledEvent(this.formElement,this.siteId)),!0}))}fetchSubmissionData(){return Object(I.a)(this,void 0,void 0,(function*(){try{if(this.workshop=yield T.a.getWorkshop(this.courseId,this.module.id),this.textAvailable=this.workshop.submissiontypetext!=T.g.SUBMISSION_TYPE_DISABLED,this.textRequired=this.workshop.submissiontypetext==T.g.SUBMISSION_TYPE_REQUIRED,this.fileAvailable=this.workshop.submissiontypefile!=T.g.SUBMISSION_TYPE_DISABLED,this.fileRequired=this.workshop.submissiontypefile==T.g.SUBMISSION_TYPE_REQUIRED,this.editForm.controls.content.setValidators(this.textRequired?k.F.required:null),this.submissionId>0){this.editing=!0,this.submission=yield O.a.getSubmissionById(this.workshopId,this.submissionId,{cmId:this.module.id});if(!(this.userId==this.submission.authorid&&this.access.cansubmit&&this.access.modifyingsubmissionallowed))return this.forceLeavePage(),void 0}else if(!this.access.cansubmit||!this.access.creatingsubmissionallowed)return this.forceLeavePage(),void 0;const e=yield F.a.getSubmissions(this.workshopId);e&&e.length?(this.hasOffline=!0,this.submission=yield O.a.applyOfflineData(this.submission,e)):this.hasOffline=!1,this.submission&&(this.originalData.title=this.submission.title||"",this.originalData.content=this.submission.content||"",this.originalData.attachmentfiles=[],(this.submission.attachmentfiles||[]).forEach((e=>{let s=J.a.getFileName(e);s||(s=H.a.getFilenameFromPath(e)||""),this.originalData.attachmentfiles.push({filename:s,fileurl:"fileurl"in e?e.fileurl:""})})),this.editForm.controls.title.setValue(this.submission.title),this.editForm.controls.content.setValue(this.submission.content),this.attachments=this.submission.attachmentfiles||[]),this.loaded=!0}catch(e){this.loaded=!1,y.a.showErrorModalDefault(e,"core.course.errorgetmodule",!0),this.forceLeavePage()}}))}forceLeavePage(){this.forceLeave=!0,r.a.back()}getInputData(){const e={title:this.editForm.value.title,content:"",attachmentfiles:[]};return this.textAvailable&&(e.content=this.editForm.value.content||""),this.fileAvailable&&(e.attachmentfiles=this.attachments),e}hasDataChanged(){if(!this.loaded)return!1;const e=this.getInputData();return!!(this.originalData.title!=e.title||this.textAvailable&&this.originalData.content!=e.content)||!!this.fileAvailable&&B.a.areFileListDifferent(e.attachmentfiles,this.originalData.attachmentfiles)}save(){return Object(I.a)(this,void 0,void 0,(function*(){if(this.hasDataChanged())try{yield this.saveSubmission(),this.forceLeavePage()}catch(e){}else this.forceLeavePage()}))}saveSubmission(){var e;return Object(I.a)(this,void 0,void 0,(function*(){const s=this.getInputData();if(!s.title)throw y.a.showAlertTranslated("core.notice","addon.mod_workshop.submissionrequiredtitle"),new j.a(x.J.instant("addon.mod_workshop.submissionrequiredtitle"));const t=M.a.htmlIsBlank(s.content),o=!s.attachmentfiles.length;if(this.textRequired&&t||this.fileRequired&&o||t&&o)throw y.a.showAlertTranslated("core.notice","addon.mod_workshop.submissionrequiredcontent"),new j.a(x.J.instant("addon.mod_workshop.submissionrequiredcontent"));let a=!1;const i=yield y.a.showModalLoading("core.sending",!0),n=null===(e=this.submission)||void 0===e?void 0:e.id;this.textAvailable&&(s.content=M.a.formatHtmlLines(s.content));let r=!s.attachmentfiles.length;try{let e,t,o;try{e=yield O.a.uploadOrStoreSubmissionFiles(this.workshopId,s.attachmentfiles,!1)}catch(e){if(Y.a.isWebServiceError(e))throw e;a=!0,r=!0,t=yield O.a.uploadOrStoreSubmissionFiles(this.workshopId,s.attachmentfiles,!0)}a||this.fileAvailable||(e=void 0),this.editing?a?(yield F.a.saveSubmission(this.workshopId,this.courseId,s.title,s.content,t,n,T.b.UPDATE),o=!1):o=yield T.a.updateSubmission(this.workshopId,n,this.courseId,s.title,s.content,e,void 0,r):a?(yield F.a.saveSubmission(this.workshopId,this.courseId,s.title,s.content,t,void 0,T.b.ADD),o=!1):o=yield T.a.addSubmission(this.workshopId,this.courseId,s.title,s.content,e,void 0,r),S.a.triggerFormSubmittedEvent(this.formElement,!!o,this.siteId);const d={workshopId:this.workshopId};o&&(F.a.deleteSubmissionAction(this.workshopId,this.editing?T.b.UPDATE:T.b.ADD),O.a.deleteSubmissionStoredFiles(this.workshopId,this.siteId),d.submissionId=o),W.b.trigger(W.b.ACTIVITY_DATA_SENT,{module:"workshop"});const c=o?T.a.invalidateSubmissionData(this.workshopId,o):Promise.resolve();yield c.finally((()=>{W.b.trigger(T.f.SUBMISSION_CHANGED,d,this.siteId),B.a.clearTmpFiles(s.attachmentfiles)}))}catch(e){y.a.showErrorModalDefault(e,"Cannot save submission")}finally{i.dismiss()}}))}getFilesComponentId(){return this.workshopId+"_"+(this.submissionId>0?this.submissionId:"newsub")}ngOnDestroy(){this.isDestroyed=!0,D.a.unblockOperation(this.component,this.workshopId)}}return AddonModWorkshopEditSubmissionPage.ɵfac=function AddonModWorkshopEditSubmissionPage_Factory(e){return new(e||AddonModWorkshopEditSubmissionPage)(c.yc(k.f))},AddonModWorkshopEditSubmissionPage.ɵcmp=c.sc({type:AddonModWorkshopEditSubmissionPage,selectors:[["page-addon-mod-workshop-edit-submission"]],viewQuery:function AddonModWorkshopEditSubmissionPage_Query(e,s){var t;(1&e&&c.ud(X,!0),2&e)&&(c.dd(t=c.Nc())&&(s.formElement=t.first))},decls:17,vars:14,consts:[["slot","start"],[3,"text"],["slot","end"],["fill","clear",3,"click"],[3,"hideUntil"],[3,"formGroup",4,"ngIf"],[3,"formGroup"],["editFormEl",""],[1,"ion-text-wrap"],["position","stacked"],["core-mark-required","true"],["name","title","type","text","formControlName","title",3,"placeholder"],[4,"ngIf"],["allowOffline","true",3,"files","maxSize","maxSubmissions","component","componentId","acceptedTypes","required","courseId",4,"ngIf"],[3,"core-mark-required"],["name","content","contextLevel","module","elementId","content_editor",3,"control","placeholder","component","componentId","autoSave","contextInstanceId","draftExtraParams"],["allowOffline","true",3,"files","maxSize","maxSubmissions","component","componentId","acceptedTypes","required","courseId"]],template:function AddonModWorkshopEditSubmissionPage_Template(e,s){1&e&&(c.Ec(0,"ion-header"),c.Ec(1,"ion-toolbar"),c.Ec(2,"ion-buttons",0),c.zc(3,"ion-back-button",1),c.Pc(4,"translate"),c.Dc(),c.Ec(5,"ion-title"),c.Ec(6,"h1"),c.pd(7),c.Pc(8,"translate"),c.Dc(),c.Dc(),c.Ec(9,"ion-buttons",2),c.Ec(10,"ion-button",3),c.Mc("click",(function AddonModWorkshopEditSubmissionPage_Template_ion_button_click_10_listener(){return s.save()})),c.Pc(11,"translate"),c.pd(12),c.Pc(13,"translate"),c.Dc(),c.Dc(),c.Dc(),c.Dc(),c.Ec(14,"ion-content"),c.Ec(15,"core-loading",4),c.nd(16,AddonModWorkshopEditSubmissionPage_form_16_Template,11,9,"form",5),c.Dc(),c.Dc()),2&e&&(c.lc(3),c.Vc("text",c.Qc(4,6,"core.back")),c.lc(4),c.qd(c.Qc(8,8,"addon.mod_workshop.editsubmission")),c.lc(3),c.mc("aria-label",c.Qc(11,10,"core.save")),c.lc(2),c.rd(" ",c.Qc(13,12,"core.save")," "),c.lc(3),c.Vc("hideUntil",s.loaded),c.lc(1),c.Vc("ngIf",s.workshop))},directives:[l.C,l.Ab,l.m,l.h,l.i,l.yb,L.a,l.l,u.a,l.v,R.a,C.t,k.H,k.s,k.k,l.I,l.O,N.a,l.H,l.Pb,k.r,k.i,z.a,K.a],pipes:[p.d],encapsulation:2}),AddonModWorkshopEditSubmissionPage})();var $=t("aEIl"),ee=t("3zv0"),se=t("Lmwl"),te=t("4qNr"),oe=t("fQ68"),ae=t("8/N+"),ie=t("0QZc"),ne=t("uHIS"),re=t("w+Pn"),de=t("r8G5"),ce=t("5450"),le=t("W5pS"),he=t("WPIK"),me=t("p+Qc"),ue=t("qNqN"),pe=t("xpMl"),ge=t("FTxb"),fe=t("/K1O"),_e=t("9pYf"),be=t("eAud"),ve=t("ACV2"),Ie=t("/BoF"),ke=t("TKc2"),we=t("whRm"),Ae=t("O4u7"),Ee=t("lqoc"),Pe=t("3lz8"),De=t("46ml"),ye=t("QQhE"),Me=t("MpCO"),xe=t("JYLr"),We=t("vWwc"),Se=t("NhJP"),Te=t("rztj"),Oe=t("rf3J"),Fe=t("nEkO"),Ve=t("TF0o"),Le=t("p5uK"),Ce=t("6uVz"),Re=t("d0nH"),qe=t("NcPy"),Ge=t("yNDK"),Ne=t("3CSS"),ze=t("iSJP"),Qe=t("iJls"),Ue=t("ArDJ"),je=t("nu3w"),Be=t("saTE"),Je=t("8PoL"),He=t("4a38"),Ye=t("OZH1"),Ke=t("edOc"),Xe=t("3jOR"),Ze=t("6A9T"),$e=t("Uzd6"),es=t("0w4i"),ss=t("G92Y"),ts=t("1iFe"),os=t("dne1"),as=t("Cg42"),is=t("llyR"),ns=t("uYHD"),rs=t("SspJ"),ds=t("U2xU"),cs=t("lAaw"),ls=t("1ArG");const hs=[{path:":courseId/:cmId",component:g},{path:":courseId/:cmId/:submissionId",component:b.a,canDeactivate:[a.a]},{path:":courseId/:cmId/:submissionId/edit",component:Z,canDeactivate:[a.a]},{path:":courseId/:cmId/:submissionId/:assessmentId",component:U,canDeactivate:[a.a]}];let ms=(()=>{class AddonModWorkshopLazyModule{}return AddonModWorkshopLazyModule.ɵmod=c.wc({type:AddonModWorkshopLazyModule}),AddonModWorkshopLazyModule.ɵinj=c.vc({factory:function AddonModWorkshopLazyModule_Factory(e){return new(e||AddonModWorkshopLazyModule)},imports:[[o.m.forChild(hs),i.a,_.a,v.a]]}),AddonModWorkshopLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&c.kd(ms,{declarations:[g,b.a,U,Z],imports:[o.m,i.a,_.a,v.a]})),c.jd(b.a,[o.n,o.j,o.l,o.k,o.p,C.q,C.r,C.s,C.t,C.A,C.w,C.x,C.y,C.z,C.u,C.v,K.a,$.a,ee.a,se.a,te.a,oe.a,ae.a,ie.a,ne.a,re.a,de.a,ce.a,le.a,he.a,me.a,ue.a,pe.a,ge.a,R.a,fe.a,N.a,_e.a,be.a,ve.a,Ie.a,ke.a,we.a,Ae.a,Ee.a,Pe.a,De.a,ye.a,Me.a,xe.a,We.a,Se.a,Te.a,q.a,Oe.a,Fe.a,Ve.a,Le.a,Ce.a,Re.a,qe.a,Ge.a,Ne.a,m.a,ze.a,Qe.a,Ue.a,je.a,Be.a,Je.a,He.a,h.b,Ye.a,Ke.a,Xe.a,u.a,L.a,Ze.a,k.H,k.w,k.G,k.c,k.x,k.A,k.a,k.D,k.E,k.z,k.r,k.s,k.C,k.o,k.n,k.y,k.b,k.d,k.u,k.v,k.t,l.f,l.g,l.h,l.j,l.k,l.l,l.m,l.n,l.o,l.p,l.q,l.r,l.s,l.t,l.u,l.v,l.w,l.x,l.y,l.z,l.A,l.B,l.C,l.D,l.E,l.F,l.G,l.H,l.I,l.J,l.K,l.L,l.M,l.N,l.O,l.P,l.Q,l.R,l.S,l.T,l.U,l.V,l.W,l.X,l.Y,l.Z,l.ab,l.bb,l.cb,l.db,l.eb,l.fb,l.hb,l.ib,l.jb,l.kb,l.lb,l.mb,l.nb,l.ob,l.pb,l.qb,l.rb,l.sb,l.tb,l.vb,l.wb,l.xb,l.zb,l.Ab,l.yb,l.ub,l.d,l.Jb,l.Mb,l.Ob,l.Pb,l.gb,l.i,l.Hb,l.Nb,l.Rb,l.Sb,l.Tb,l.Bb,k.h,k.k,k.i,k.l,k.e,p.a,d.a,$e.a,es.a,ss.a,G.a,z.a,g,b.a,U,Z],[C.b,C.G,C.p,C.k,C.E,C.g,C.C,C.F,C.d,C.f,C.i,C.j,C.l,ts.a,os.a,as.a,is.a,ns.a,rs.a,ds.a,cs.a,ls.a,p.d])}}]);